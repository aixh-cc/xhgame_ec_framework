"use strict";var e=require("fs"),t=require("path"),n=require("adm-zip");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var o=s(e);function i(e,t,n,s){return new(n||(n=Promise))(function(o,i){function r(e){try{l(s.next(e))}catch(e){i(e)}}function c(e){try{l(s.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,c)}l((s=s.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;const r=()=>{if("undefined"!=typeof Editor&&Editor.Project)return Editor.Project.path;{let e=t.resolve("./");for(;;){const n=t.join(e,"extensions");try{if(o.statSync(n).isDirectory())return console.log("getProjectPath:"+e),e}catch(e){}const s=t.resolve(e,"..");if(s===e)break;e=s}throw new Error("未找到项目根目录：未检测到“extensions”目录")}},c=()=>{let e=r();return t.join(e,"extensions")},l=(e,n)=>{let s=r();return t.join(s,"extensions",e,"packages",n)};class a{constructor(e){this.logs=[],this.extensionPath="",this.projectPath="",this.pluginName=e,this.extensionPath=c(),this.projectPath=r(),this.installInfoPath=t.join(this.extensionPath,e+"-installInfo.json")}exists(){return o.existsSync(this.installInfoPath)}readInstallInfo(){return i(this,void 0,void 0,function*(){const e={version:"1.0.0",lastUpdated:(new Date).toISOString(),installedComponents:[]};try{if(o.existsSync(this.installInfoPath)){const t=yield o.promises.readFile(this.installInfoPath,"utf-8"),n=JSON.parse(t);return Object.assign(e,n)}}catch(e){console.warn(`[${this.pluginName}] 读取安装信息失败，将使用默认配置:`,e)}return e})}writeInstallInfo(e){return i(this,void 0,void 0,function*(){try{return e.lastUpdated=(new Date).toISOString(),yield o.promises.writeFile(this.installInfoPath,JSON.stringify(e,null,2),"utf-8"),this.logs.push(`[${this.pluginName}] 安装信息已写入: ${this.installInfoPath.replace(this.projectPath,"")}`),!0}catch(e){return this.logs.push(`[${this.pluginName}] 写入安装信息失败: ${e}`),console.error(`[${this.pluginName}] 写入安装信息失败:`,e),!1}})}getLogs(){return this.logs}checkInstallExists(){return i(this,void 0,void 0,function*(){try{return this.exists()?yield this.readInstallInfo():null}catch(e){return console.warn(`[${this.pluginName}] 检查安装信息失败:`,e),null}})}getInstalledComponentCodes(){return i(this,void 0,void 0,function*(){return(yield this.readInstallInfo()).installedComponents.map(e=>e.componentCode)})}isComponentInstalled(e){return i(this,void 0,void 0,function*(){return(yield this.getInstalledComponentCodes()).indexOf(e)>-1})}getComponentInfo(e){return i(this,void 0,void 0,function*(){return(yield this.readInstallInfo()).installedComponents.find(t=>t.componentCode===e)||null})}extractComponentMetadata(e,t){return i(this,void 0,void 0,function*(){let n=t,s=t,i=t,r="1.0.0";try{const c=e+".meta";if(o.existsSync(c)){const e=yield o.promises.readFile(c,"utf-8"),l=JSON.parse(e);(null==l?void 0:l.userData)&&(n=l.userData.name||t,s=l.userData.name||t,i=l.userData.displayName||t,r=l.userData.version||r)}}catch(e){console.warn(`[${this.pluginName}] 提取组件元数据失败:`,e)}return{componentCode:n,componentId:s,componentDisplayName:i,componentVersion:r}})}recordInstallation(e,t,n,s){return i(this,void 0,void 0,function*(){try{const n=yield this.readInstallInfo(),o=yield this.extractComponentMetadata(e,t);n.installedComponents=n.installedComponents.filter(e=>e.componentCode!==o.componentCode),n.installedComponents.push({componentName:o.componentDisplayName,componentId:o.componentId,componentCode:o.componentCode,version:o.componentVersion,copiedFiles:s,installedAt:(new Date).toISOString()}),yield this.writeInstallInfo(n),console.log(`[${this.pluginName}] 组件安装信息已记录: ${o.componentCode}`)}catch(e){throw console.warn(`[${this.pluginName}] 记录安装信息失败，但组件安装已完成:`,e),e}})}removeComponent(e){return i(this,void 0,void 0,function*(){try{const t=yield this.readInstallInfo();if(t.installedComponents&&Array.isArray(t.installedComponents)){const n=t.installedComponents.length;t.installedComponents=t.installedComponents.filter(t=>t.componentCode!==e),t.installedComponents.length<n&&console.log(`[${this.pluginName}] 已从 installedComponents 中移除组件: ${e}`)}yield this.writeInstallInfo(t),console.log(`[${this.pluginName}] 组件记录已从安装信息中移除: ${e}`)}catch(e){throw console.warn(`[${this.pluginName}] 移除组件记录失败:`,e),e}})}}class u{static getInstallInfoManager(e){return new a(e)}static getVersion(e){return i(this,void 0,void 0,function*(){const e=r(),n=t.join(e,"package.json");if(o.existsSync(n)){const e=JSON.parse(yield o.promises.readFile(n,"utf-8"));if(void 0!==e.creator)return{success:!0,version:e.creator.version}}return{success:!0,version:"未知版本"}})}static getComponentInfos(e,n){return i(this,void 0,void 0,function*(){var s;console.log("getComponentInfos",e,n);try{const i=l(e,n);if(!o.existsSync(i))return{success:!1,error:"Packages directory not found",groupPath:"",componentInfos:[]};const r=u.getInstallInfoManager(e),c=yield r.checkInstallExists();let a=(null===(s=null==c?void 0:c.installedComponents)||void 0===s?void 0:s.map(e=>e.componentCode))||[];console.log("installedLists",a);const d=o.readdirSync(i),p=[];for(const e of d){if(!e.endsWith(".setup.json"))continue;const s=t.join(i,e);try{const i=yield o.promises.readFile(s,"utf-8"),r=JSON.parse(i);if(r&&"object"==typeof r){const s={code:r.code||t.basename(e,".setup.json"),displayName:r.displayName||t.basename(e,".setup.json"),version:r.version||"1.0.0",description:r.description||"",author:r.author||"",category:r.category||n,tags:Array.isArray(r.tags)?r.tags:[],path:r.path||"",dependencies:Array.isArray(r.dependencies)?r.dependencies:[],files:Array.isArray(r.files)?r.files:[],installStatus:a.indexOf(r.code||t.basename(e,".setup.json"))>-1?"has":"none",backupStatus:"none"};p.push(s)}}catch(t){console.error(`读取或解析 ${e} 失败:`,t)}}return{success:!0,groupPath:i,componentInfos:p}}catch(e){return{success:!1,error:"Failed to get items",groupPath:"",componentInfos:[]}}})}static installComponent(e){return i(this,void 0,void 0,function*(){var s;const{compName:c,pluginName:a,group:d}=e;if(!c||!a||!d)return{success:!1,error:"组件名或插件名或者分组不能为空"};console.log(`[xhgame_builder] 安装组件请求: ${c}`,e);let p="";try{let m=l(a,d);console.log(`[xhgame_builder] 组件安装目录: ${m}`);const h=t.join(m,`${c}.zip`),f=t.join(m,c);let y=f;if(o.existsSync(h)){console.log(`[xhgame_builder] 发现zip包，准备解压: ${h}`),p=t.join(m,"__extract",c),yield o.promises.mkdir(p,{recursive:!0});new n(h).extractAllTo(p,!0),console.log(`[xhgame_builder] 解压完成到: ${p}`);const C=(yield o.promises.readdir(p,{withFileTypes:!0})).filter(e=>e.isDirectory()&&"__MACOSX"!==e.name);let _=p;1===C.length&&(_=t.join(p,C[0].name));const w=t.join(_,"assets");y=o.existsSync(w)?w:_}else{if(!o.existsSync(f))return{success:!1,error:`未找到组件资源：${h} 或 ${f}`};console.log(`[xhgame_builder] 使用旧目录模式: ${f}`),y=f}const g=r(),v=t.join(g,"assets");yield o.promises.mkdir(v,{recursive:!0}),console.log(`[xhgame_builder] 源路径: ${y}`),console.log(`[xhgame_builder] 目标路径: ${v}`);const x=[],j=[],I=[];function $(e,n){return i(this,arguments,void 0,function*(e,n,s=""){const i=yield o.promises.readdir(e,{withFileTypes:!0});for(const r of i){const i=t.join(n,r.name),c=t.join(s,r.name);if(!r.name.endsWith(".meta"))if(r.isDirectory()){const n=t.join(e,r.name);yield $(n,i,c)}else try{yield o.promises.access(i),j.push(c)}catch(e){}}})}const b=h+".meta";if(o.existsSync(h)&&o.existsSync(b))try{const N=yield o.promises.readFile(b,"utf-8"),P=JSON.parse(N),k=Array.isArray(null===(s=null==P?void 0:P.userData)||void 0===s?void 0:s.files)?P.userData.files:[];if(console.log("需要进行copy的filesList",k),!k.length)return{success:!1,error:`安装失败：组件 ${c} 的 meta 未声明要安装的 files`};for(const F of k){if(F.endsWith(".meta"))continue;const O=t.join(v,F);try{yield o.promises.access(O),j.push(F)}catch(E){}}if(j.length>0)return console.log(`[xhgame_builder] 检测到冲突文件: ${j.join("\n")}`),{success:!1,error:`安装失败：检测到以下文件已存在，请先删除或备份这些文件：\n${j.join("\n")}`};function D(e){return i(this,void 0,void 0,function*(){for(const n of e){const e=t.join(y,n),s=t.join(v,n);try{(yield o.promises.stat(e)).isDirectory()?(yield o.promises.mkdir(s,{recursive:!0}),yield S(e,s,n)):(yield o.promises.mkdir(t.dirname(s),{recursive:!0}),yield o.promises.copyFile(e,s),x.push(n),console.log(`[xhgame_builder] 复制文件: ${n}`))}catch(e){I.push(n),console.warn(`[xhgame_builder] 缺失文件（未在压缩包中找到）: ${n}`)}}})}if(console.log(`[xhgame_builder] 使用meta files列表进行复制，文件数量: ${k.length}`),yield D(k),I.length>0)return{success:!1,error:`安装失败：以下声明的文件在压缩包中未找到：\n${I.join("\n")}`}}catch(A){return{success:!1,error:`安装失败：读取组件meta失败或格式错误（${String(A)}）`}}else{if(yield $(y,v),j.length>0)return console.log(`[xhgame_builder] 检测到冲突文件: ${j.join("\n")}`),{success:!1,error:`安装失败：检测到以下文件已存在，请先删除或备份这些文件：\n${j.join("\n")}`};console.log("[xhgame_builder] 没有冲突文件，开始复制整个目录..."),yield S(y,v)}function S(e,n){return i(this,arguments,void 0,function*(e,n,s=""){const i=yield o.promises.readdir(e,{withFileTypes:!0});for(const r of i){const i=t.join(e,r.name),c=t.join(n,r.name),l=t.join(s,r.name);if(r.isDirectory()){if(r.name.endsWith(".meta"))continue;yield o.promises.mkdir(c,{recursive:!0}),yield S(i,c,l)}else yield o.promises.copyFile(i,c),x.push(l),console.log(`[xhgame_builder] 复制文件: ${l}`)}})}console.log(`[xhgame_builder] 组件安装完成，共复制 ${x.length} 个文件`);try{const J=u.getInstallInfoManager(a);yield J.recordInstallation(h,c,v,x)}catch(M){console.warn("[xhgame_builder] 写入安装信息失败，但组件安装已完成:",M)}return{success:!0,error:`组件 ${c} 从内置资源安装成功！`}}catch(T){return console.error("[xhgame_builder] 从内置资源安装组件失败: ",T),{success:!1,error:T instanceof Error?T.message:String(T)}}finally{if(p&&o.existsSync(p))try{yield o.promises.rm(p,{recursive:!0,force:!0});const W=t.join(l(a,d),"__extract");try{0===(yield o.promises.readdir(W)).length&&(yield o.promises.rm(W,{recursive:!0,force:!0}))}catch(z){}}catch(q){console.warn(`[xhgame_builder] 清理临时目录失败: ${p}`,q)}}})}static uninstallComponent(e){return i(this,void 0,void 0,function*(){var n;console.log("uninstallComponent",e);const{compName:s,pluginName:c}=e;if(!s||!c)return{success:!1,error:"组件名或插件名不能为空"};console.log(`[xhgame_builder] 安装卸载组件请求: ${s}`,e);try{const e=r(),l=t.join(e,"assets"),a=u.getInstallInfoManager(c),d=yield a.checkInstallExists();if(!d)return{success:!1,error:"未找到组件安装信息文件"};const p=null===(n=d.installedComponents)||void 0===n?void 0:n.find(e=>e.componentCode===s);if(!p)return{success:!1,error:`未找到组件 ${s} 的安装记录`};const m=[],h=[];for(const e of p.copiedFiles){const n=t.join(l,e);try{yield o.promises.access(n),yield o.promises.unlink(n),m.push(e),console.log(`[xhgame_builder] 删除文件: ${e}`)}catch(t){console.warn(`[xhgame_builder] 文件不存在或处理失败: ${e}`,t),h.push(e)}}const f=e=>i(this,void 0,void 0,function*(){try{const n=yield o.promises.readdir(e);for(const s of n){const n=t.join(e,s);(yield o.promises.stat(n)).isDirectory()&&(yield f(n))}0===(yield o.promises.readdir(e)).length&&(yield o.promises.rmdir(e),console.log(`[xhgame_builder] 删除空目录: ${e}`))}catch(e){}});yield f(l);try{const e=u.getInstallInfoManager(c);yield e.removeComponent(s)}catch(e){console.warn("[xhgame_builder] 移除组件记录失败:",e)}return console.log(`[xhgame_builder] 组件卸载完成: ${p.componentName}`),{success:!0}}catch(e){return console.error("[xhgame_builder] 卸载组件失败: ",e),{success:!1,error:e instanceof Error?e.message:String(e)}}})}static checkInstallExists(e){return i(this,void 0,void 0,function*(){const{pluginName:t}=e;if(!t)return{success:!1,error:"插件名不能为空"};try{const e=u.getInstallInfoManager(t),n=yield e.checkInstallExists();return n?{success:!0,installInfo:n}:{success:!0,installInfo:[]}}catch(e){return console.error("[xhgame_builder] 检查备份文件失败:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}})}}class d{static packItem(e){return i(this,arguments,void 0,function*(e,n="pack_demo"){try{const s=r();if(!e||!e.startsWith("assets/"))return{success:!1,error:"请输入以 assets/ 开头的资源路径"};const i=t.join(s,e);if(!(o.existsSync(i)&&o.statSync(i).isDirectory()))return{success:!1,error:`源目录不存在：${e}`};const c=t.basename(i),l=e.replace(/^assets\//,"").split("/");if(l.length<2)return{success:!1,error:"资源路径格式不正确"};const a=l[l.length-2],u=t.join(s,"extensions",n,"packages",a,c),p=t.join(u,"bundle_factory","item_views",a),m=t.join(p,c);yield o.promises.rm(u,{recursive:!0,force:!0}).catch(()=>{}),yield o.promises.mkdir(m,{recursive:!0});const h=[];yield d.copyDirectory(i,m,e=>{h.push(t.join("bundle_factory","item_views",a,c,e))});const f=i+".meta";if(o.existsSync(f)&&o.statSync(f).isFile()){const e=t.join(p,c+".meta");yield o.promises.copyFile(f,e),h.push(t.join("bundle_factory","item_views",a,c+".meta"))}const y=t.join(s,"extensions",n,"packages",a,`${c}.setup.json`);return yield d.writeSetupJson(y,{itemName:c,group:a,files:h}),{success:!0,targetPath:u,copiedFiles:h}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}})}static copyDirectory(e,n,s){return i(this,void 0,void 0,function*(){yield o.promises.mkdir(n,{recursive:!0});const i=yield o.promises.readdir(e,{withFileTypes:!0});for(const r of i){const i=t.join(e,r.name),c=t.join(n,r.name);r.isDirectory()?yield d.copyDirectory(i,c,e=>{s&&s(t.join(r.name,e))}):(yield o.promises.copyFile(i,c),s&&s(r.name))}})}static writeSetupJson(e,n){return i(this,void 0,void 0,function*(){const{itemName:s,group:i,files:r}=n;let c=null;try{if(o.existsSync(e)){const t=yield o.promises.readFile(e,"utf-8"),n=JSON.parse(t);"object"==typeof n&&n&&(n.files=r,c=n)}}catch(e){c=null}if(!c){c={code:s,displayName:s,version:"1.0.0",description:"",author:"auto",category:i,tags:[],path:t.join("bundle_factory","item_views",i,s),dependencies:[],files:r}}yield o.promises.writeFile(e,JSON.stringify(c,null,2),"utf-8")})}}exports.Handles=u,exports.InstallInfoManager=a,exports.Pack=d,exports.getExtensionsPath=c,exports.getGroupPath=l,exports.getPackagesPath=e=>{let n=r();return t.join(n,"extensions",e,"packages")},exports.getPluginPath=e=>{let n=r();return t.join(n,"extensions",e)},exports.getProjectPath=r;
