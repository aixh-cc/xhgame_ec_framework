import*as e from"fs";import{resolve as t,join as s,basename as n,dirname as o}from"path";import i from"adm-zip";function r(e,t,s,n){return new(s||(s=Promise))(function(o,i){function r(e){try{l(n.next(e))}catch(e){i(e)}}function c(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,c)}l((n=n.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;const c=()=>{if("undefined"!=typeof Editor&&Editor.Project)return Editor.Project.path;{let n=t("./");for(;;){const o=s(n,"extensions");try{if(e.statSync(o).isDirectory())return console.log("getProjectPath:"+n),n}catch(e){}const i=t(n,"..");if(i===n)break;n=i}throw new Error("未找到项目根目录：未检测到“extensions”目录")}},l=()=>{let e=c();return s(e,"extensions")},a=e=>{let t=c();return s(t,"extensions",e)},d=e=>{let t=c();return s(t,"extensions",e,"packages")},u=(e,t)=>{let n=c();return s(n,"extensions",e,"packages",t)};class m{constructor(e){this.logs=[],this.extensionPath="",this.projectPath="",this.pluginName=e,this.extensionPath=l(),this.projectPath=c(),this.installInfoPath=s(this.extensionPath,e+"-installInfo.json")}exists(){return e.existsSync(this.installInfoPath)}readInstallInfo(){return r(this,void 0,void 0,function*(){const t={version:"1.0.0",lastUpdated:(new Date).toISOString(),installedComponents:[]};try{if(e.existsSync(this.installInfoPath)){const s=yield e.promises.readFile(this.installInfoPath,"utf-8"),n=JSON.parse(s);return Object.assign(t,n)}}catch(e){console.warn(`[${this.pluginName}] 读取安装信息失败，将使用默认配置:`,e)}return t})}writeInstallInfo(t){return r(this,void 0,void 0,function*(){try{return t.lastUpdated=(new Date).toISOString(),yield e.promises.writeFile(this.installInfoPath,JSON.stringify(t,null,2),"utf-8"),this.logs.push(`[${this.pluginName}] 安装信息已写入: ${this.installInfoPath.replace(this.projectPath,"")}`),!0}catch(e){return this.logs.push(`[${this.pluginName}] 写入安装信息失败: ${e}`),console.error(`[${this.pluginName}] 写入安装信息失败:`,e),!1}})}getLogs(){return this.logs}checkInstallExists(){return r(this,void 0,void 0,function*(){try{return this.exists()?yield this.readInstallInfo():null}catch(e){return console.warn(`[${this.pluginName}] 检查安装信息失败:`,e),null}})}getInstalledComponentCodes(){return r(this,void 0,void 0,function*(){return(yield this.readInstallInfo()).installedComponents.map(e=>e.componentCode)})}isComponentInstalled(e){return r(this,void 0,void 0,function*(){return(yield this.getInstalledComponentCodes()).indexOf(e)>-1})}getComponentInfo(e){return r(this,void 0,void 0,function*(){return(yield this.readInstallInfo()).installedComponents.find(t=>t.componentCode===e)||null})}extractComponentMetadata(t,s){return r(this,void 0,void 0,function*(){let n=s,o=s,i=s,r="1.0.0";try{const c=t+".meta";if(e.existsSync(c)){const t=yield e.promises.readFile(c,"utf-8"),l=JSON.parse(t);(null==l?void 0:l.userData)&&(n=l.userData.name||s,o=l.userData.name||s,i=l.userData.displayName||s,r=l.userData.version||r)}}catch(e){console.warn(`[${this.pluginName}] 提取组件元数据失败:`,e)}return{componentCode:n,componentId:o,componentDisplayName:i,componentVersion:r}})}recordInstallation(e,t,s,n){return r(this,void 0,void 0,function*(){try{const s=yield this.readInstallInfo(),o=yield this.extractComponentMetadata(e,t);s.installedComponents=s.installedComponents.filter(e=>e.componentCode!==o.componentCode),s.installedComponents.push({componentName:o.componentDisplayName,componentId:o.componentId,componentCode:o.componentCode,version:o.componentVersion,copiedFiles:n,installedAt:(new Date).toISOString()}),yield this.writeInstallInfo(s),console.log(`[${this.pluginName}] 组件安装信息已记录: ${o.componentCode}`)}catch(e){throw console.warn(`[${this.pluginName}] 记录安装信息失败，但组件安装已完成:`,e),e}})}removeComponent(e){return r(this,void 0,void 0,function*(){try{const t=yield this.readInstallInfo();if(t.installedComponents&&Array.isArray(t.installedComponents)){const s=t.installedComponents.length;t.installedComponents=t.installedComponents.filter(t=>t.componentCode!==e),t.installedComponents.length<s&&console.log(`[${this.pluginName}] 已从 installedComponents 中移除组件: ${e}`)}yield this.writeInstallInfo(t),console.log(`[${this.pluginName}] 组件记录已从安装信息中移除: ${e}`)}catch(e){throw console.warn(`[${this.pluginName}] 移除组件记录失败:`,e),e}})}}class p{static getInstallInfoManager(e){return new m(e)}static getVersion(t){return r(this,void 0,void 0,function*(){const t=c(),n=s(t,"package.json");if(e.existsSync(n)){const t=JSON.parse(yield e.promises.readFile(n,"utf-8"));if(void 0!==t.creator)return{success:!0,version:t.creator.version}}return{success:!0,version:"未知版本"}})}static getComponentInfos(t,o){return r(this,void 0,void 0,function*(){var i;console.log("getComponentInfos",t,o);try{const r=u(t,o);if(!e.existsSync(r))return{success:!1,error:"Packages directory not found",groupPath:"",componentInfos:[]};const c=p.getInstallInfoManager(t),l=yield c.checkInstallExists();let a=(null===(i=null==l?void 0:l.installedComponents)||void 0===i?void 0:i.map(e=>e.componentCode))||[];console.log("installedLists",a);const d=e.readdirSync(r),m=[];for(const t of d){if(!t.endsWith(".setup.json"))continue;const i=s(r,t);try{const s=yield e.promises.readFile(i,"utf-8"),r=JSON.parse(s);if(r&&"object"==typeof r){const e={code:r.code||n(t,".setup.json"),displayName:r.displayName||n(t,".setup.json"),version:r.version||"1.0.0",description:r.description||"",author:r.author||"",category:r.category||o,tags:Array.isArray(r.tags)?r.tags:[],path:r.path||"",dependencies:Array.isArray(r.dependencies)?r.dependencies:[],files:Array.isArray(r.files)?r.files:[],installStatus:a.indexOf(r.code||n(t,".setup.json"))>-1?"has":"none",backupStatus:"none"};m.push(e)}}catch(e){console.error(`读取或解析 ${t} 失败:`,e)}}return{success:!0,groupPath:r,componentInfos:m}}catch(e){return{success:!1,error:"Failed to get items",groupPath:"",componentInfos:[]}}})}static installComponent(t){return r(this,void 0,void 0,function*(){var n;const{compName:l,pluginName:a,group:d}=t;if(!l||!a||!d)return{success:!1,error:"组件名或插件名或者分组不能为空"};console.log(`[xhgame_builder] 安装组件请求: ${l}`,t);let m="";try{let h=u(a,d);console.log(`[xhgame_builder] 组件安装目录: ${h}`);const f=s(h,`${l}.zip`),y=s(h,l);let g=y;if(e.existsSync(f)){console.log(`[xhgame_builder] 发现zip包，准备解压: ${f}`),m=s(h,"__extract",l),yield e.promises.mkdir(m,{recursive:!0});new i(f).extractAllTo(m,!0),console.log(`[xhgame_builder] 解压完成到: ${m}`);const b=(yield e.promises.readdir(m,{withFileTypes:!0})).filter(e=>e.isDirectory()&&"__MACOSX"!==e.name);let N=m;1===b.length&&(N=s(m,b[0].name));const k=s(N,"assets");g=e.existsSync(k)?k:N}else{if(!e.existsSync(y))return{success:!1,error:`未找到组件资源：${f} 或 ${y}`};console.log(`[xhgame_builder] 使用旧目录模式: ${y}`),g=y}const v=c(),x=s(v,"assets");yield e.promises.mkdir(x,{recursive:!0}),console.log(`[xhgame_builder] 源路径: ${g}`),console.log(`[xhgame_builder] 目标路径: ${x}`);const I=[],$=[],S=[];function C(t,n){return r(this,arguments,void 0,function*(t,n,o=""){const i=yield e.promises.readdir(t,{withFileTypes:!0});for(const r of i){const i=s(n,r.name),c=s(o,r.name);if(!r.name.endsWith(".meta"))if(r.isDirectory()){const e=s(t,r.name);yield C(e,i,c)}else try{yield e.promises.access(i),$.push(c)}catch(e){}}})}const _=f+".meta";if(e.existsSync(f)&&e.existsSync(_))try{const D=yield e.promises.readFile(_,"utf-8"),P=JSON.parse(D),j=Array.isArray(null===(n=null==P?void 0:P.userData)||void 0===n?void 0:n.files)?P.userData.files:[];if(console.log("需要进行copy的filesList",j),!j.length)return{success:!1,error:`安装失败：组件 ${l} 的 meta 未声明要安装的 files`};for(const E of j){if(E.endsWith(".meta"))continue;const O=s(x,E);try{yield e.promises.access(O),$.push(E)}catch(A){}}if($.length>0)return console.log(`[xhgame_builder] 检测到冲突文件: ${$.join("\n")}`),{success:!1,error:`安装失败：检测到以下文件已存在，请先删除或备份这些文件：\n${$.join("\n")}`};function F(t){return r(this,void 0,void 0,function*(){for(const n of t){const t=s(g,n),i=s(x,n);try{(yield e.promises.stat(t)).isDirectory()?(yield e.promises.mkdir(i,{recursive:!0}),yield w(t,i,n)):(yield e.promises.mkdir(o(i),{recursive:!0}),yield e.promises.copyFile(t,i),I.push(n),console.log(`[xhgame_builder] 复制文件: ${n}`))}catch(e){S.push(n),console.warn(`[xhgame_builder] 缺失文件（未在压缩包中找到）: ${n}`)}}})}if(console.log(`[xhgame_builder] 使用meta files列表进行复制，文件数量: ${j.length}`),yield F(j),S.length>0)return{success:!1,error:`安装失败：以下声明的文件在压缩包中未找到：\n${S.join("\n")}`}}catch(J){return{success:!1,error:`安装失败：读取组件meta失败或格式错误（${String(J)}）`}}else{if(yield C(g,x),$.length>0)return console.log(`[xhgame_builder] 检测到冲突文件: ${$.join("\n")}`),{success:!1,error:`安装失败：检测到以下文件已存在，请先删除或备份这些文件：\n${$.join("\n")}`};console.log("[xhgame_builder] 没有冲突文件，开始复制整个目录..."),yield w(g,x)}function w(t,n){return r(this,arguments,void 0,function*(t,n,o=""){const i=yield e.promises.readdir(t,{withFileTypes:!0});for(const r of i){const i=s(t,r.name),c=s(n,r.name),l=s(o,r.name);if(r.isDirectory()){if(r.name.endsWith(".meta"))continue;yield e.promises.mkdir(c,{recursive:!0}),yield w(i,c,l)}else yield e.promises.copyFile(i,c),I.push(l),console.log(`[xhgame_builder] 复制文件: ${l}`)}})}console.log(`[xhgame_builder] 组件安装完成，共复制 ${I.length} 个文件`);try{const M=p.getInstallInfoManager(a);yield M.recordInstallation(f,l,x,I)}catch(T){console.warn("[xhgame_builder] 写入安装信息失败，但组件安装已完成:",T)}return{success:!0,error:`组件 ${l} 从内置资源安装成功！`}}catch(W){return console.error("[xhgame_builder] 从内置资源安装组件失败: ",W),{success:!1,error:W instanceof Error?W.message:String(W)}}finally{if(m&&e.existsSync(m))try{yield e.promises.rm(m,{recursive:!0,force:!0});const z=s(u(a,d),"__extract");try{0===(yield e.promises.readdir(z)).length&&(yield e.promises.rm(z,{recursive:!0,force:!0}))}catch(L){}}catch(V){console.warn(`[xhgame_builder] 清理临时目录失败: ${m}`,V)}}})}static uninstallComponent(t){return r(this,void 0,void 0,function*(){var n;console.log("uninstallComponent",t);const{compName:o,pluginName:i}=t;if(!o||!i)return{success:!1,error:"组件名或插件名不能为空"};console.log(`[xhgame_builder] 安装卸载组件请求: ${o}`,t);try{const t=c(),l=s(t,"assets"),a=p.getInstallInfoManager(i),d=yield a.checkInstallExists();if(!d)return{success:!1,error:"未找到组件安装信息文件"};const u=null===(n=d.installedComponents)||void 0===n?void 0:n.find(e=>e.componentCode===o);if(!u)return{success:!1,error:`未找到组件 ${o} 的安装记录`};const m=[],h=[];for(const t of u.copiedFiles){const n=s(l,t);try{yield e.promises.access(n),yield e.promises.unlink(n),m.push(t),console.log(`[xhgame_builder] 删除文件: ${t}`)}catch(e){console.warn(`[xhgame_builder] 文件不存在或处理失败: ${t}`,e),h.push(t)}}const f=t=>r(this,void 0,void 0,function*(){try{const n=yield e.promises.readdir(t);for(const o of n){const n=s(t,o);(yield e.promises.stat(n)).isDirectory()&&(yield f(n))}0===(yield e.promises.readdir(t)).length&&(yield e.promises.rmdir(t),console.log(`[xhgame_builder] 删除空目录: ${t}`))}catch(e){}});yield f(l);try{const e=p.getInstallInfoManager(i);yield e.removeComponent(o)}catch(e){console.warn("[xhgame_builder] 移除组件记录失败:",e)}return console.log(`[xhgame_builder] 组件卸载完成: ${u.componentName}`),{success:!0}}catch(e){return console.error("[xhgame_builder] 卸载组件失败: ",e),{success:!1,error:e instanceof Error?e.message:String(e)}}})}static checkInstallExists(e){return r(this,void 0,void 0,function*(){const{pluginName:t}=e;if(!t)return{success:!1,error:"插件名不能为空"};try{const e=p.getInstallInfoManager(t),s=yield e.checkInstallExists();return s?{success:!0,installInfo:s}:{success:!0,installInfo:[]}}catch(e){return console.error("[xhgame_builder] 检查备份文件失败:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}})}}class h{static packItem(t){return r(this,arguments,void 0,function*(t,o="pack_demo"){try{const i=c();if(!t||!t.startsWith("assets/"))return{success:!1,error:"请输入以 assets/ 开头的资源路径"};const r=s(i,t);if(!(e.existsSync(r)&&e.statSync(r).isDirectory()))return{success:!1,error:`源目录不存在：${t}`};const l=n(r),a=t.replace(/^assets\//,"").split("/");if(a.length<2)return{success:!1,error:"资源路径格式不正确"};const d=a[a.length-2],u=s(i,"extensions",o,"packages",d,l),m=s(u,"bundle_factory","item_views",d),p=s(m,l);yield e.promises.rm(u,{recursive:!0,force:!0}).catch(()=>{}),yield e.promises.mkdir(p,{recursive:!0});const f=[];yield h.copyDirectory(r,p,e=>{f.push(s("bundle_factory","item_views",d,l,e))});const y=r+".meta";if(e.existsSync(y)&&e.statSync(y).isFile()){const t=s(m,l+".meta");yield e.promises.copyFile(y,t),f.push(s("bundle_factory","item_views",d,l+".meta"))}const g=s(i,"extensions",o,"packages",d,`${l}.setup.json`);return yield h.writeSetupJson(g,{itemName:l,group:d,files:f}),{success:!0,targetPath:u,copiedFiles:f}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}})}static copyDirectory(t,n,o){return r(this,void 0,void 0,function*(){yield e.promises.mkdir(n,{recursive:!0});const i=yield e.promises.readdir(t,{withFileTypes:!0});for(const r of i){const i=s(t,r.name),c=s(n,r.name);r.isDirectory()?yield h.copyDirectory(i,c,e=>{o&&o(s(r.name,e))}):(yield e.promises.copyFile(i,c),o&&o(r.name))}})}static writeSetupJson(t,n){return r(this,void 0,void 0,function*(){const{itemName:o,group:i,files:r}=n;let c=null;try{if(e.existsSync(t)){const s=yield e.promises.readFile(t,"utf-8"),n=JSON.parse(s);"object"==typeof n&&n&&(n.files=r,c=n)}}catch(e){c=null}if(!c){c={code:o,displayName:o,version:"1.0.0",description:"",author:"auto",category:i,tags:[],path:s("bundle_factory","item_views",i,o),dependencies:[],files:r}}yield e.promises.writeFile(t,JSON.stringify(c,null,2),"utf-8")})}}export{p as Handles,m as InstallInfoManager,h as Pack,l as getExtensionsPath,u as getGroupPath,d as getPackagesPath,a as getPluginPath,c as getProjectPath};
